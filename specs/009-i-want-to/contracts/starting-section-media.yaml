openapi: 3.0.0
info:
  title: Starting Section Media API
  version: 1.0.0
  description: API contract for managing starting section background media (images and videos)

paths:
  /api/wedding/media/starting-section:
    post:
      summary: Upload background media
      description: Uploads an image or video file to use as background for the starting section. Requires confirmation if replacing existing media.
      operationId: uploadStartingSectionMedia
      tags:
        - Starting Section Media
      security:
        - sessionCookie: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
                  description: Image or video file to upload
                replaceExisting:
                  type: boolean
                  description: Set to true to confirm replacement of existing media
                  default: false
              required:
                - file
      responses:
        '200':
          description: File uploaded successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      filename:
                        type: string
                        description: Generated filename for the uploaded file
                        example: "background-image-1697654321.jpg"
                      fileSize:
                        type: integer
                        description: File size in bytes
                        example: 2458624
                      mimeType:
                        type: string
                        description: MIME type of the uploaded file
                        example: "image/jpeg"
                      type:
                        type: string
                        enum: [image, video]
                        description: Media type category
                        example: "image"
                  requiresConfirmation:
                    type: boolean
                    description: True if existing file found and replaceExisting was false
                    example: false
                  existingFile:
                    type: string
                    nullable: true
                    description: Filename of existing media if requiresConfirmation is true
                    example: null
              examples:
                successfulUpload:
                  summary: Successful upload (no existing file)
                  value:
                    success: true
                    data:
                      filename: "background-image-1697654321.jpg"
                      fileSize: 2458624
                      mimeType: "image/jpeg"
                      type: "image"
                confirmationRequired:
                  summary: Confirmation required (existing file found)
                  value:
                    success: false
                    requiresConfirmation: true
                    existingFile: "background-video-1697554321.mp4"
                    message: "Existing media file will be deleted. Set replaceExisting=true to confirm."
        '400':
          description: Validation error (file size exceeded or invalid type)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                imageTooLarge:
                  summary: Image exceeds 10MB limit
                  value:
                    success: false
                    error: "Image file size exceeds maximum of 10 MB"
                videoTooLarge:
                  summary: Video exceeds 50MB limit
                  value:
                    success: false
                    error: "Video file size exceeds maximum of 50 MB"
                invalidType:
                  summary: Unsupported file type
                  value:
                    success: false
                    error: "Invalid file type. Supported types: image/jpeg, image/png, image/webp, image/gif, video/mp4, video/webm"
        '401':
          description: Unauthorized - no valid session
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: "Unauthorized"
        '413':
          description: Payload too large
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: "File size exceeds server limit"
        '500':
          description: Server error during upload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: "Failed to upload media file"

    delete:
      summary: Delete background media
      description: Removes the current background media file and clears related database fields
      operationId: deleteStartingSectionMedia
      tags:
        - Starting Section Media
      security:
        - sessionCookie: []
      responses:
        '200':
          description: Media deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Background media deleted successfully"
        '401':
          description: Unauthorized - no valid session
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: "Unauthorized"
        '404':
          description: No media file to delete
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: "No background media found to delete"
        '500':
          description: Server error during deletion
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: "Failed to delete media file"

components:
  securitySchemes:
    sessionCookie:
      type: apiKey
      in: cookie
      name: session
      description: Session-based authentication cookie

  schemas:
    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: string
          example: "Error message"
      required:
        - success
        - error

# File Upload Constraints
#
# Images:
#   - Maximum size: 10 MB (10,485,760 bytes)
#   - Supported MIME types: image/jpeg, image/png, image/webp, image/gif
#   - Extensions: .jpg, .jpeg, .png, .webp, .gif
#
# Videos:
#   - Maximum size: 50 MB (52,428,800 bytes)
#   - Supported MIME types: video/mp4, video/webm
#   - Extensions: .mp4, .webm
#
# Replacement Policy (FR-018):
#   - If existing media file exists, API returns requiresConfirmation: true
#   - Client must re-submit with replaceExisting: true to proceed
#   - Old file is deleted from filesystem after successful new upload
#   - All database fields updated atomically (filename, fileSize, mimeType, type)
#
# Storage Location:
#   - public/uploads/{weddingConfigId}/starting-section/
#   - Filename pattern: background-{type}-{timestamp}.{ext}
#   - Timestamp: Unix seconds since epoch
